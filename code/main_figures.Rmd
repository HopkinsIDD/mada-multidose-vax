---
title: "Main Text Figures"
author: "Forrest Jones"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load data and functions

```{r}
source("code/utils.R")

analysis <- read_rds("data/tidy_data/analysisList.rds")

analysis.DTP<- analysis[[1]]
analysis.PCV10<- analysis[[2]]
analysis.Rota<- analysis[[3]]

```


### Figure 1. Vaccination card database characteristics and timeliness classifications for each vaccine dose. 

A) Circle area corresponds to the number of vaccination cards analyzed for urban (blue, italics) and rural (black) districts. Districts (total = 119, selected in dark tan) were selected from highlighted regions (light tan) for the study. B) Y-axis indicates the number of vaccination cards analyzed with a birthdate for a given month and district. The months of vaccination weeks (VW) and the supplementary immunization activity (SIA) are indicated; children are not eligible for VWs or the SIA until they reach the target age range. The month of card collection is shown by a yellow card icon. C) Children are scheduled to receive doses of DTP and PCV10 at 6, 10, and 14 weeks; rotavirus vaccine schedule does not include a third dose. Black arrows indicate the occurrence of birth, first dose, and second dose.  Color indicates timeliness of each dose (Blue=Early, Green = On time, Orange=Late). Timeliness of 

Take figure 1b into powerpoint.
```{r}

# 
# 
# #Figure 1a
# p1a <- rasterGrob(readPNG("Custom Figures/map_fig.png"),interpolate=TRUE)
# 
# 
# f1a <- qplot(1:10, 1:10, geom="blank") +
#   annotation_custom(p1a, xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf) + theme_void()


#Figure 1b
VWlabels <- data.frame(
labels =c("VW", "VW", "VW", "SIA", "Card Collection"),
x =as.Date(c("2015-05-01","2015-10-01","2016-05-01","2016-10-01", "2017-04-01")) ,
y = c(rep(-10,4),-10)
)

library(RColorBrewer)

f1b <- analysis.DTP %>% mutate(
                month = floor_date(DDN , "month")+15
        ) %>% group_by(month, District) %>%
        summarize(count=n()) %>% 
        ggplot(aes(x=month,
                   y= count,
                   col=District)) +
                geom_point(size=2,alpha=0.7) +
                geom_line(lwd=1,alpha=0.7)+
                ylab("Vaccination Cards") +
                xlab("Birth Month") +
        #facet_wrap(.~District, nrow=3) +
        #theme(legend.position = "none") +
                geom_text(inherit.aes=FALSE,data=VWlabels,
                          aes(x=x,y=y,label=labels),
                          angle=0, #hjust="left",
                          fontface="bold") +
        scale_color_brewer(palette = "Set1" )+
         xlim(as.Date("2014-12-01"),
             as.Date("2017-07-01")) +
        theme_cowplot()+
        theme(legend.position = c(0.7,0.7))+
        geom_hline(yintercept=0)

f1b
ggsave("figures/main_figures/f1b.png",plot=f1b,
       height = 3.3, width = 6.2)
                       

```

### Figure 2: Coverage Estimates
```{r}

as.Date("2017-02-01")-365


#coverage figures
#figure 2a table
f2a_tab <-      bind_rows(
                        getCovLat(analysis.DTP)[[1]] %>%
                                mutate(antigen="DTP"),
                        getCovLat(analysis.PCV10)[[1]]%>%
                                mutate(antigen="PCV10"),
                        getCovLat(analysis.Rota)[[1]]%>%
                                mutate(antigen="Rotavirus")
                        ) %>%
        mutate(cov=round(cov,2)) %>%
        mutate(cov=ifelse(antigen=="Rotavirus" & dose=="Third",NA,cov),
               lb=ifelse(antigen=="Rotavirus" & dose=="Third",NA,lb),
               ub=ifelse(antigen=="Rotavirus" & dose=="Third",NA,ub)) 

#figure 2a ggplot
f2a <- f2a_tab %>%  
        ggplot(aes(x=antigen,y=cov*100,fill=dose)) +
        geom_bar(stat="identity",
                 position = position_dodge(0.9),
                 alpha=0.5) +
        geom_errorbar(aes(ymin=lb*100,ymax=ub*100,
                      col=dose),
                      position = position_dodge(0.9),
                      width=0.5) +
        ylab("Coverage at 1-year old (%)") +
        xlab("Vaccine")+ ylim(c(0,100)) +
        scale_colour_grey("Dose",start=0.8, end=0.2)+
        scale_fill_grey("Dose",start=0.8, end=0.2)+

        geom_text(aes(label=cov*100,x=antigen,y=100*cov+5,group=dose),
                   position = position_dodge(0.9))+theme_cowplot()+
        theme(legend.position="none")

#figure 2b table
f2b_tab <-   stratifyCovLat(analysis.DTP,"District")[[1]] %>%
                mutate(cov=round(cov,2)) %>%
                mutate(District=factor(stratum, levels=levels(analysis.DTP$District),
                                              labels= c("MAH","MAR",
                                                        "TU1","TU2",
                                                        "MAN","VOH"))) %>%
                mutate(urban = ifelse(stratum %in% c("MAHAJANGA I","MANAKARA","TULEAR I"),
                                      "Urban","Rural"),
                       urban=factor(urban,levels=c("Urban","Rural")))
#figure 2b annotation
f2b_ann_text <- data.frame(cov = .05,
                           pLate = .025,
                       dose=factor(c(1,1),levels=as.character(1:3)),
                       District = factor(c("TU1","TU2"),
                                      levels = levels(f2b_tab$District)),
                       lab = c("Urban","Rural"),
                       urban = factor(c("Urban","Rural"),
                                      levels = c("Urban","Rural")))

#figure 2b ggplot
f2b <- f2b_tab %>% ggplot(aes(x=District,y=cov*100,
                              col = dose, group=dose)) +
                geom_point()+
                geom_errorbar(aes(ymin=lb*100,ymax=ub*100,col = dose,group=dose),
                      width =0.25) +
        scale_colour_grey(start=0.8, end=0.2)+
        ylab("Coverage at 1-year old (%)")+
        ylim(c(0,100))+ 
        geom_text(data = f2b_ann_text,aes(label=lab),col="black")+ 

        facet_grid(.~urban, 
                   scales = "free")+
        theme_cowplot()+theme(  legend.position="none",
                                axis.title.y = element_blank(),
                                strip.background = element_blank(),
                                strip.text.x = element_blank()
                                )


#figure 2c table
f2c_tab <-stratifyCovLat(analysis.DTP,"birth.month")[[1]] %>%
                mutate(cov=round(cov,2)) %>%
                mutate(birth.month=factor(as.numeric(stratum),levels=1:12))

#figure 2c ggplot
f2c <- f2c_tab %>% ggplot(aes(x=birth.month,y=cov*100, 
                              col = dose, group=dose)) +
                geom_point()+#position=position_dodge(width = .5)) +
                geom_line()+#position=position_dodge(width = .5)) +
        geom_errorbar(aes(ymin=lb*100,ymax=ub*100,col = dose,group=dose),
                      #position=position_dodge(width = .5),
                      width =0.25) +
                scale_colour_grey("Dose",start=0.8, end=0.2)+
        ylab("Coverage at 1-year old (%)") +
        xlab("Birth Month")+
        ylim(c(0,100))+theme_cowplot()+
        theme(axis.title.y = element_blank())






#lateness figures

#figure 2d table
f2d_tab <- bind_rows(
                        getCovLat(analysis.DTP)[[2]] %>%
                                mutate(antigen="DTP"),
                        getCovLat(analysis.PCV10)[[2]]%>%
                                mutate(antigen="PCV10"),
                        getCovLat(analysis.Rota)[[2]]%>%
                                mutate(antigen="Rotavirus")
                        ) %>%
        mutate(pLate=round(lateness,2)) %>%
        mutate(pLate=ifelse(antigen=="Rotavirus" & dose=="Third",NA,pLate))

# figure 2d ggplot
f2def_cols <- c("#fe9929", "#cc4c02", "#662506") #colors for lateness
f2d <- f2d_tab %>% 
        ggplot(aes(x=antigen,y=pLate*100,fill=dose)) +
        geom_bar(stat="identity",
                 position = position_dodge(0.9),
                 alpha=0.5) +
        ylab("Percentage receiving late doses (%)") +
        xlab("Vaccine")+ ylim(c(0,50)) +
        scale_fill_manual(values=f2def_cols)+
        scale_color_manual(values=f2def_cols) +
        geom_text(aes(label=pLate*100,x=antigen,y=pLate*100+5,group=dose),
                   position = position_dodge(0.9))+theme_cowplot()+
        theme(legend.position="none")

# figure 2e table
f2e_tab <- stratifyCovLat(analysis.DTP,"District")[[2]] %>%
                mutate(pLate=round(lateness,2)) %>%
                mutate(District=factor(stratum, levels=levels(analysis.DTP$District),
                                              labels= c("MAH","MAR",
                                                        "TU1","TU2",
                                                        "MAN","VOH"))) %>%
                mutate(urban = ifelse(stratum %in% c("MAHAJANGA I","MANAKARA","TULEAR I"),
                                      "Urban","Rural"),
                       urban=factor(urban,levels=c("Urban","Rural")))
# figure 2e ggplot
f2e <- f2e_tab %>%
        ggplot(aes(x=District,y=pLate*100,
                              col = dose, group=dose)) +
                geom_point()+
         scale_color_manual(values=f2def_cols) +
        ylim(c(0,50))+ 
        geom_text(data = f2b_ann_text,aes(label=lab),col="black")+

        facet_grid(.~urban,
                   scales = "free")+
        theme_cowplot()+theme(  legend.position="none",
                                axis.title.y = element_blank(),
                                strip.background = element_blank(),
                                strip.text.x = element_blank()
                                )

# figure 2f table
f2f_tab <-stratifyCovLat(analysis.DTP,"birth.month")[[2]] %>%
                mutate(pLate=round(lateness,2)) %>%
                mutate(birth.month=factor(as.numeric(stratum),levels=1:12))
# figure 2f ggplot
f2f <- f2f_tab %>%
        ggplot(aes(x=birth.month,y=pLate*100, 
                              col = dose, group=dose)) +
                geom_point()+
                geom_line()+
         scale_color_manual("Dose",values=f2def_cols) +
        xlab("Birth Month")+
        ylim(c(0,50))+theme_cowplot()+
        theme(axis.title.y = element_blank())



#bring it all together
f2 <- plot_grid(ggplot+theme_void(),f2a,f2b,f2c,
                ggplot+theme_void(),f2d,f2e,f2f,nrow=2,
                labels = c("A","","B","C","D","","E","F"),
                align = "hv",axis="lb",rel_widths = c(0.1,1.3, 1,1.3))
ggsave("figures/main_figures/fig2.pdf",plot=f2,
       height = 6.3, width = 11.4)
ggsave("figures/main_figures/fig2.tiff",plot=f2,
       height = 6.3, width = 11.4)
ggsave("figures/main_figures/fig2.png",plot=f2,
       height = 6.3, width = 11.4)

```



### Figure 3: RiverPlot for cohort

```{r}

pDTP <- makeRiverPlot(analysis.DTP,"DTP") +
                  theme_cowplot()+
                  theme(legend.position = "none")
pPCV <- makeRiverPlot(analysis.PCV10,"PCV10")+
                  theme_cowplot()+
                  theme(legend.position = "none")

pRota <-makeRiverPlot(analysis.Rota,"Rota") +
                  theme_cowplot()+
                  ggtitle("Rotavirus")

pRP <- plot_grid(pDTP,
          pPCV,
          plot_grid(pRota,
                    ggplot() + theme_void(),
                    rel_widths = c(0.75,0.25)),
          labels = c("A","B","C"),
          ncol=1)

ggsave("figures/main_figures/fig3.tiff",plot=pRP,
       height = 9, width = 7.5)
ggsave("figures/main_figures/fig3.pdf",plot=pRP,
       height = 9, width = 7.5)
ggsave("figures/main_figures/fig3.png",plot=pRP,
       height = 9, width = 7.5)




```

### Figure 4: District- level DTP coverage estimates by timeliness of prior doses.
Among children who received their first (A) and second (B) doses, coverage estimates for the following doses were calculated using the Kaplan-Meier method. Color indicates timeliness of the prior dose (Orange = Late, Green = On Time). Districts are abbreviated with three characters (MAH=Mahajanga I; TU1=Tulear I; MAN=Manakara; MAR=Maravoay; TU2=Tulear II, VOH=Vohipeno).
```{r}


f4_tab <- NULL

for (i in unique(analysis.DTP$District)){
        
        #create district specific weighted df
        tmp_df <- filter(analysis.DTP, District==i)
        tmp_df <- createWeightedDF(tmp_df)
        
        #second dose coverage by timeliness
        tmp_df_1ontime <- filter(tmp_df,V1.timeliness == "OnTime")
        tmp_df_1late   <- filter(tmp_df,V1.timeliness == "Late")
        
        fit_2ontime    <- survfit(Surv(T2, D2) ~ 1, 
                                  data = tmp_df_1ontime ,weights=W2)
        fit_2late    <- survfit(Surv(T2, D2) ~ 1, 
                                  data = tmp_df_1late,weights=W2)
        
        #third dose coverage by timeliness
        tmp_df_2ontime <- filter(tmp_df,V2.timeliness == "OnTime")
        tmp_df_2late   <- filter(tmp_df,V2.timeliness == "Late")
        
        fit_3ontime    <-survfit(Surv(T3, D3) ~ 1, 
                                  data = tmp_df_2ontime,weights=W3)
        fit_3late    <-survfit(Surv(T3, D3) ~ 1, 
                                  data = tmp_df_2late,weights=W3)
        
        covdf <- bind_rows(
                (1-getSurv(fit_2ontime,52)) %>%
                        mutate(
                                dose="Second",
                                timeliness="On Time"
                        ),
                (1-getSurv(fit_2late,52))%>%
                        mutate(
                                dose="Second",
                                timeliness="Late"
                        ),
                (1-getSurv(fit_3ontime,52))%>%
                        mutate(
                                dose="Third",
                                timeliness="On Time"
                        ),
                (1-getSurv(fit_3late,52))%>%
                        mutate(
                                dose="Third",
                                timeliness="Late"
                        )
                )%>%
                rename(cov=surv) %>%
                #switch upperbound and lowerbound
                rename(tmp=lb,
                       lb=ub) %>%
                rename(ub=tmp) %>%
                mutate(District=i)


        f4_tab <- bind_rows(covdf,f4_tab)
       
}

f4_tab <-f4_tab %>%
        mutate(urban = ifelse(District %in% 
                                      c("MAHAJANGA I","TULEAR I",
                                        "MANAKARA")
                              ,"Urban","Rural")) %>%
        mutate(urban = factor(urban, levels = c("Urban","Rural"))) %>%
        
        mutate(
               District=factor(District,
                               levels=levels(
                                       analysis.DTP$District),
                               labels = c("MAH","MAR",
                                        "TU1","TU2",
                                        "MAN","VOH")))


#ggplot plot f4a
f4_ann_text <- data.frame(cov = .05,
                       timeliness=factor(c(1,1),levels=as.character(
                               c("OnTime","Late"))),
                       District = factor(c("TU1","TU2"),
                                      levels = levels(f4_tab$District)),
                       lab = c("Urban","Rural"),
                       urban = factor(c("Urban","Rural"),
                                      levels = c("Urban","Rural")))



f4_a<- f4_tab %>% filter(dose=="Second") %>%
        ggplot(aes(x=District,y=cov*100,
                              col = timeliness, group=timeliness)) +
                geom_point()+
        geom_errorbar(aes(ymin=lb*100,
                          ymax=ub*100,
                          col = timeliness,group=timeliness),
                      width =0.25) +
        scale_color_manual(name="Timeliness \n of Prior Dose",
                           values=c("#ff7f00","#4daf4a")) +
        ylab("Second Dose Coverage (%)")+
        ylim(c(0,100))+ 
        geom_text(data = f4_ann_text,aes(label=lab),col="black")+
        facet_grid(.~urban, #space = "free",
                   scales = "free")+
        
        theme_cowplot()+theme( 
                                #axis.title.y = element_blank(),
                                strip.background = element_blank(),
                                strip.text.x = element_blank()
                                )


f4_b <- f4_tab %>% filter(dose=="Third") %>%
        ggplot(aes(x=District,y=cov*100,
                              col = timeliness, group=timeliness)) +
                geom_point()+
        geom_errorbar(aes(ymin=lb*100,
                          ymax=ub*100,
                          col = timeliness,group=timeliness),
                      width =0.25) +
        scale_color_manual(values=c("#ff7f00","#4daf4a")) +
        ylab("Third Dose Coverage (%)")+
        ylim(c(0,100))+ 
        geom_text(data = f4_ann_text,aes(label=lab),col="black")+ 
        facet_grid(.~urban, #space = "free",
                   scales = "free")+
        
        theme_cowplot()+theme( 
                                #axis.title.y = element_blank(),
                                strip.background = element_blank(),
                                strip.text.x = element_blank()
                                )


f4 <- plot_grid(  f4_a+theme(legend.position = c(0.75,0.25)),
                        ggplot+theme_void(),
                        f4_b+theme(legend.position = "none"),
                        rel_widths = c(1,0.1,1),
                  labels = c("A","","B"),
          nrow=1)

ggsave("figures/main_figures/fig4.pdf",plot=f4,
       height = 4.5, width = 10.5)
ggsave("figures/main_figures/fig4.tiff",plot=f4,
       height = 4.5, width = 10.5)
ggsave("figures/main_figures/fig4.png",plot=f4,
       height = 4.5, width = 10.5)



```

### Figure 5. Predicted weekly probability of vaccination for each dose of DTP vaccination (A) and simulated impact of catch-up campaigns (B). 
The y-axis represents the probability of DTP vaccination on a given week among individuals eligible for on-time or late vaccination in Tulear I. Area represents the 95% confidence intervals and the line in a Loess smooth function. Timing of VWs (black dashed) and the 2016 SIA (blue dotted) are indicated. (B) The simulated coverage of the third dose of DTP vaccine of children at 1-year of age is shown on the y-axis for different levels of catch-up on VWs.

```{r}

Ontime1 <- splitFit_ontime(analysis.DTP,dose = 1)
Ontime2 <- splitFit_ontime(analysis.DTP,dose = 2)
Ontime3 <- splitFit_ontime(analysis.DTP,dose = 3)
        
Late1 <- splitFit_late(analysis.DTP,dose = 1)
Late2 <- splitFit_late(analysis.DTP,dose = 2)
Late3 <- splitFit_late(analysis.DTP,dose = 3)
        
fits <- bind_rows(Ontime1,Ontime2,Ontime3,
                  Late1,Late2,Late3)

#vaccination week and SIA dates
VW <- as.Date(c("2015-05-11","2015-10-28","2016-05-09","2016-10-26"))+3


# fits %>% #filter(upr<100)%>%
#         ggplot(aes(x = as.Date(week), y = fit,
#                    ymin = lwr, ymax = upr,
#                     col=factor(timeliness),fill=factor(timeliness)
# 
#                     )) +
#         facet_wrap(Dose~.,ncol=1)+
#         geom_point() +
#         geom_ribbon(alpha=0.1, col=NA) +
#         geom_smooth( se = FALSE, method = "loess") +
#         geom_vline(xintercept=VW[1:3],lty=2,size=1) +
#         geom_vline(xintercept=VW[4],col="blue",lty=3,size=1)+
#         ylab("Weekly Probability \n of Vaccination (%)") +
#         xlab("Week of Vaccination")+
#         xlim(as.Date(c("2015-01-01","2017-03-01")))+
#         theme_cowplot()+
#         scale_y_continuous(limits=c(0,100))

f5a  <- fits %>% filter(Dose ==1) %>%
        ggplot(aes(x = as.Date(week), y = fit,
                   ymin = lwr, ymax = upr,
                    col=factor(timeliness),fill=factor(timeliness)
                   
                    )) +
        geom_point() + 
        geom_ribbon(alpha=0.1, col=NA) +
        geom_smooth(method = "loess", se = FALSE) +
        geom_vline(xintercept=VW,
                   col=c("black","black","black","blue"),
                   lty=c(2,2,2,3),
                   size=1) +
        scale_color_manual(values=c("orange","darkgreen"),
                           name="Timeliness")+
        scale_fill_manual(values=c("orange","darkgreen"),
                          name="Timeliness")+
        scale_y_continuous("Weekly Probability \n of Vaccination (%)",
                           limits=c(0,100))+
        scale_x_date("Week of Vaccination", 
                     limits = c(as.Date("2015-01-01"),
                                as.Date("2017-03-01")))+
        theme_cowplot()
     
        


        
#         filter(analysis.DTP,B1.SA.time>=6) %>%
#         mutate(
#                censor=ifelse(B1.SA.time>10,0,V1.SA.censor),
#                entry = DDN + 6*7,
#                exit  = ifelse(B1.SA.time>10,
#                              as.character(DDN + (10*7)),
#                              as.character(DDN + round(7*B1.SA.time))),
#                exit = as.Date(exit)
#                        ) %>%
#         filter(entry!=exit) %>%
#         select(ID,DDN,B1.SA.time,V1.SA.censor,entry,exit,censor,District)%>%
#         splitter() %>% mutate(Dose=1,timeliness="On Time")
# 
# 
# newOT <-Ontime1 %>% group_by(week,District) %>%
#                         summarize(PT=sum(PT)/7, #combine PT and change to weeks
#                                   vax=sum(censor)
#                                   )
# 
# model <- glm(data=newOT, vax ~ -1 + factor(week)+District,
#                               offset=log(PT),
#                               family=poisson(link="log")
#         ) %>% predict.glm(data.frame(week=sort(unique(newOT$week)),
#                                      District="TULEAR I",PT=1),
#                           se.fit=TRUE)
# 
# 
#  conFint <- data.frame(fit=model$fit,
#                               lwr=model$fit-1.96*model$se.fit,
#                               upr=model$fit+1.96*model$se.fit
#         )
#         
#         # interval='confidence', level=0.95) 
#         # output predictions
#        fit1 <- data.frame(week=sort(unique(newOT$week)),
#                    Dose=1,
#                    timeliness="On Time",
#                    exp(conFint)*100)


# Ontime1 <- filter(analysis.DTP,B1.SA.time>6) %>%
#         mutate(censor=ifelse(B1.SA.time>10,0,V1.SA.censor),
#                entry = DDN + 6*7,
#                exit = ifelse(B1.SA.time>10,
#                              DDN + (10*7),
#                              DDN + round(7*B1.SA.time))) %>%
#         select(ID,DDN,B1.SA.time,V1.SA.censor,entry,exit,censor,District)%>%
#         splitter() %>% mutate(Dose=1,timeliness="On Time")



# Ontime2 <- filter(analysis.DTP,B2.SA.time>4) %>%
#         mutate(censor=ifelse(B2.SA.time>8,0,V2.SA.censor),
#                entry = V1.date + 4*7,
#                exit = ifelse(B2.SA.time>8,
#                              V1.date + (8*7),
#                              V1.date + round(7*B2.SA.time))) %>%
#         select(ID,V1.date,B2.SA.time,V2.SA.censor,entry,exit,censor,District) %>%
#         splitter() %>% mutate(Dose=2,timeliness="On Time")
# 
# Ontime3 <- filter(analysis.DTP,B3.SA.time>4) %>%
#         mutate(censor=ifelse(B3.SA.time>8,0,V3.SA.censor),
#                entry = V2.date + 4*7,
#                exit = ifelse(B3.SA.time>8,
#                              V2.date + (8*7),
#                              V2.date + round(7*B3.SA.time))) %>%
#         select(ID,V2.date,B3.SA.time,V3.SA.censor,entry,exit,censor,District) %>%
#         splitter() %>% mutate(Dose=3,timeliness="On Time")
# 
# 
# Late1 <- filter(analysis.DTP,B1.SA.time>10) %>%
#         mutate(censor=V1.SA.censor,
#                entry = DDN + 10*7,
#                exit = DDN + round(7*B1.SA.time)) %>%
#         select(ID,DDN,B1.SA.time,V1.SA.censor,entry,exit,censor,District) %>%
#         splitter() %>% mutate(Dose=1,timeliness="Late")

# Late2 <- filter(analysis.DTP,B2.SA.time>8) %>%
#         mutate(censor=V2.SA.censor,
#                entry = V1.date + 8*7,
#                exit = V1.date + round(7*B2.SA.time)) %>%
#         select(ID,V1.date,B2.SA.time,V2.SA.censor,entry,exit,censor,District)%>%
#         splitter() %>% mutate(Dose=2,timeliness="Late")
# 
# Late3 <- filter(analysis.DTP,B3.SA.time>8) %>%
#         mutate(censor=V3.SA.censor,
#                entry = V2.date + 8*7,
#                exit = V2.date + round(7*B3.SA.time)) %>%
#         select(ID,V2.date,B3.SA.time,V3.SA.censor,entry,exit,censor,District)%>%
#         splitter() %>% mutate(Dose=3,timeliness="Late")

# fits<-bind_rows(
#         fitter(Ontime1),
#         # fitter(Ontime2),
#         # fitter(Ontime3),
#         fitter(Late1)#,
#         # fitter(Late2),
#         # fitter(Late3)
# )



#figure 5a
# fits %>% 
#         filter(upr<20 & timeliness =="On Time" | 
#                         upr<3 & timeliness =="Late") %>%
#         ggplot(aes(x = as.Date(week), y = fit,
#                    ymin = lwr, ymax = upr,
#                     col=factor(Dose),fill=factor(Dose)
#                     )) + 
#         geom_line() + 
#         geom_ribbon(alpha=0.1, col=NA)+
#         facet_wrap(.~timeliness,scale = "free_y",ncol=1)+
#         geom_vline(xintercept=VW[1:3],lty=2,size=1) +
#         geom_vline(xintercept=VW[4],col="blue",lty=3,size=1)+
#         ylab("Predicted Weekly Hazard (%)") +
#         xlab("Week of Vaccination")+
#         scale_color_manual(values=f2cols)+
#         scale_fill_manual(values=f2cols) +
#         guides(fill=guide_legend(title="Dose"),
#                col=guide_legend(title="Dose"))



# f5a  <- fits %>% filter(upr<100 & Dose ==1) %>%
#         ggplot(aes(x = as.Date(week), y = fit,
#                    ymin = lwr, ymax = upr,
#                     col=factor(timeliness),fill=factor(timeliness)
#                    
#                     )) +
#         geom_point() + 
#         geom_ribbon(alpha=0.1, col=NA) +
#         geom_smooth( se = FALSE) +
#         #facet_wrap(.~Dose,ncol=1)+
#         geom_vline(xintercept=VW[1:3],lty=2,size=1) +
#         geom_vline(xintercept=VW[4],col="blue",lty=3,size=1)+
#         ylab("Weekly Probability \n of Vaccination (%)") +
#         xlab("Week of Vaccination")+
#         scale_color_manual(values=c("orange","darkgreen"),
#                            name="Timeliness")+
#         scale_fill_manual(values=c("orange","darkgreen"),
#                           name="Timeliness")+
#         xlim(as.Date(c("2015-01-01","2017-03-01")))+
#         theme_cowplot()
#         #theme(axis.title=element_text(size=10,face="bold"))
#         #+
#         #scale_y_continuous(trans="log10")
        
```


```{r}


vaccMatrix <- read_csv("data/generated_data/simulation_files/vaccRateMatrix.csv")  %>% select(-X1)

hazard <- getRates(analysis.DTP,1) %>% rename(rate1=prob) %>%
        left_join(getRates(analysis.DTP,2) %>% rename(rate2=prob)) %>%
        left_join(getRates(analysis.DTP,3) %>% rename(rate3=prob)) %>%
         mutate(rate2=ifelse(is.na(rate2),0,rate2),
                rate3=ifelse(is.na(rate3),0,rate3)
                ) 

# bind_rows(vaccMatrix,hi) %>%
#         gather(dose,prob,-c(tstart,status)) %>%
#         ggplot(aes(x=tstart,y=prob,col=status))+
#         geom_point()+
#         geom_line()+
#         facet_wrap(dose~.)

catchupFull <- VWsimulation(catchup = 1,   rates=hazard)
catchupHalf <- VWsimulation(catchup = 0.5, rates=hazard)
catchupTenth <- VWsimulation(catchup = 0.1,rates=hazard)
catchupNone <- VWsimulation(catchup = 0,   rates=hazard)
 
#         
#         dat %>% survSplit(data=.,Surv(as.numeric(entry), as.numeric(exit), censor)~.,
#                           cut = as.numeric(cutPoints),
#                           end = "exit") %>%
#                 mutate(PT=exit-tstart,
#                        tstart=as.Date(tstart, origin="1970-01-01"))%>%
#                 mutate(week=cut(tstart,cutPoints))
#         




#figure 5c and d

# source('markov_dates_VW.R')

# catchupFull <- VWsimulation(catchup = 1)
# catchupHalf <- VWsimulation(catchup = 0.5)
# catchupTenth <- VWsimulation(catchup = 0.1)
# catchupNone <- VWsimulation(catchup = 0)
# 
# 
# write_rds(catchupFull,"data/generated_data/simulationfiles/catchupFull.rds")
# write_rds(catchupHalf,"data/generated_data/simulationfiles/catchupHalf.rds")
# write_rds(catchupTenth,"data/generated_data/simulationfiles/catchupTenth.rds")
# write_rds(catchupNone,"data/generated_data/simulationfiles/catchupNone.rds")


catchupFull <-read_rds("data/generated_data/simulation_files/catchupFull.rds")
catchupHalf <- read_rds("data/generated_data/simulation_files/catchupHalf.rds")
catchupTenth <- read_rds("data/generated_data/simulation_files/catchupTenth.rds")
catchupNone <- read_rds("data/generated_data/simulation_files/catchupNone.rds")



# markov models

#gray.colors(3, start = 0.2, end = 0.8)
VWs <- as.Date(c("2015-05-13","2015-10-28",
                 "2016-05-09","2016-10-26")) #check if these dates were used to simulate


# VWlabels <- data.frame(
# labels =c("VW", "VW", "VW", "VW"),
# x =as.Date(c("2015-05-13","2015-10-21",
#                  "2016-05-11","2016-10-19")) ,
# y = c(rep(90,4))
# )

f5b <-bind_rows(catchupFull[[1]],
                catchupHalf[[1]],
                catchupTenth[[1]],
                catchupNone[[1]]) %>%
        ggplot() +
        geom_line(aes(x=date,y=Third,
                          col=factor(Catchup*100),
                         group=factor(Catchup))#,#,
                     #col="#333333"
                  #size=2
                     ) +
        ylim(c(70,100)) + geom_vline(xintercept=VWs, lty=2,size=1)+
        xlim(as.Date(c("2015-01-01","2017-03-01")))+
        xlab("Week of First Birthday") +
        ylab("Third Dose Coverage \n at 1-year old (%)")+
        # geom_text(inherit.aes=FALSE,data=VWlabels,
        #                   aes(x=x,y=y,label=labels),
        #                   angle=0, #hjust="left",
        #                   fontface="bold")+
       
        theme(axis.title=element_text(size=10,face="bold"))+
        scale_color_brewer(name="Catch-Up (%)",palette = "Set1")+
        theme_cowplot()+
        guides(colour = guide_legend(reverse=T))


dt <- catchupFull[[2]] %>% group_by(date) %>%
        summarize(First=sum(First),
                  Second=sum(Second),
                  Third=sum(Third)) %>%
        gather(dose,count,-date)
#dt %>% group_by(date) %>% summarize(count=sum(count)) %>% arrange(desc(count))

f5c <- dt %>%  ggplot() + geom_bar(stat="identity",
                                    aes(x=date,y=count/2559,fill=dose)) +
        xlim(as.Date(c("2015-01-01","2017-03-01"))) +
        scale_fill_grey(name="Dose",start=0.8, end=0.2)+
        xlab("Week of Vaccination") +
        ylab("Relative Number \n of Doses")+
        geom_hline(yintercept=1)+
        theme(axis.title=element_text(size=10,face="bold"))

p <- plot_grid(f5b,
          f5c+theme_cowplot(),
          ncol=1,align="hv")#labels=c("A","B","C"))


f5 <-plot_grid(f5a,f5b,ncol=1, align="v",
               labels=c("A","B"))



ggsave("figures/main_figures/fig5.tiff", plot=f5, height = 6, width = 8)
ggsave("figures/main_figures/fig5.pdf", plot=f5, height = 6, width = 8)
ggsave("figures/main_figures/fig5.png", plot=f5, height = 6, width = 8)


```

